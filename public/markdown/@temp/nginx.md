### 소개 (Introduction)

Nginx는 세계적으로 가장 인기 있는 웹 서버 중 하나로, 높은 부하와 많은 클라이언트 연결을 안정적으로 처리할 수 있습니다. 웹 서버, 메일 서버, 또는 리버스 프록시 서버로 작동하도록 설정할 수 있는 다목적 도구입니다. 본 문서는 Nginx가 클라이언트 요청을 처리하는 뒤편의 메커니즘을 설명하며, 이를 이해하면 서버와 location 블록을 설계할 때 추측에 의존하지 않고 더 체계적으로 접근할 수 있습니다.

---

### Nginx 블록 구성 (Nginx Block Configurations)

Nginx는 요청 처리 구성을 논리적으로 블록으로 나누고 계층적 구조를 유지합니다. 클라이언트 요청이 발생할 때마다, Nginx는 해당 요청을 처리할 적절한 블록을 찾아 처리합니다.

- **서버 블록 (server block)**:

  - Nginx에서 요청을 처리하기 위해 설정된 가상 서버입니다.
  - 도메인 이름, 포트, IP 주소 등에 따라 요청을 처리할 서버 블록을 결정합니다.

- **로케이션 블록 (location block)**:
  - 서버 블록 내부에 존재하며, 특정 자원(URI)에 대한 요청을 처리하는 방법을 정의합니다.
  - URI를 관리자 정의에 따라 자유롭게 세분화 가능하며, 매우 유연한 모델을 제공합니다.

---

### Nginx는 어떤 서버 블록이 요청을 처리할지 어떻게 결정하나요? (How Nginx Decides Which Server Block Will Handle a Request)

여러 개의 서버 블록이 있을 때, Nginx는 요청을 처리할 서버 블록을 다음 절차에 따라 판별합니다:

1. **`listen` 지시어 분석**:

   - 요청의 IP 주소와 포트를 확인하고 이를 각 서버 블록에 정의된 `listen` 지시어와 비교하여 가능한 후보 블록 목록을 작성합니다.
   - `listen` 지시어는 다음과 같은 형식으로 설정됩니다:
     - IP 주소와 포트 조합 (`111.111.111.111:80`)
     - IP 주소만 지정하여 기본 포트(80) 수신 (`111.111.111.111`)
     - 포트만 지정하여 모든 인터페이스 수신 (`80`)
     - Unix 소켓 경로
   - 가장 구체적으로 매칭되는 블록이 우선되며, 동일한 수준의 구체성을 가진 블록이 여러 개 있을 경우 `server_name` 지시어를 평가합니다.

2. **`server_name` 지시어 평가**:
   - 요청의 호스트 헤더(`Host`) 값을 각 서버 블록의 `server_name`과 비교하여 최적의 매칭을 찾습니다.
     - **정확히 일치하는 경우**: 첫 번째 매칭된 블록을 선택.
     - **앞쪽 와일드카드(`*`)**: 가장 긴 매칭을 선택.
     - **뒷쪽 와일드카드**: 가장 긴 매칭을 선택.
     - **정규 표현식**: 첫 번째 매칭된 블록을 선택.
   - 어느 것도 매칭되지 않을 경우, 해당 IP/포트 조합의 기본 서버 블록이 요청을 처리합니다.

---

### 로케이션 블록 매칭 (Matching Location Blocks)

서버 블록이 선택된 후, Nginx는 해당 요청을 처리할 가장 적합한 로케이션 블록을 선택합니다.

#### 로케이션 블록 구문 (Location Block Syntax)

로케이션 블록은 서버 블록 또는 다른 로케이션 블록 내부에 위치하며, 다음과 같은 형태를 갖습니다:

```nginx
location <optional_modifier> <location_match> {
    ...
}
```

- **옵션 수정자 (optional_modifier)**:
  - 없음: 접두사(prefix) 매칭. 요청 URI의 시작 부분과 비교.
  - `=`: 요청 URI가 정확히 일치하는 경우 매칭.
  - `~`: 대소문자 구분 정규식 매칭.
  - `~*`: 대소문자 구분 없는 정규식 매칭.
  - `^~`: 정규식을 무시하고 접두사 매칭 결과 우선.

#### Nginx가 로케이션 블록을 선택하는 방법

1. **접두사 기반 매칭**:

   - 가장 긴 접두사 매칭을 찾습니다.
   - `^~` 수정자가 붙은 경우 즉시 이 블록을 선택합니다.

2. **정규 표현식 평가**:

   - 정규 표현식 로케이션 블록을 순차적으로 평가하며, 처음으로 매칭되는 블록을 선택합니다.

3. **최종 선택**:
   - 정규식 블록이 없거나 매칭되지 않는 경우, 이전에 저장된 가장 긴 접두사 매칭 블록을 선택합니다.

#### 점프 로케이션

일부 지시어는 다른 로케이션 블록으로 재검색을 유발할 수 있습니다:

- **index**: 디렉토리 요청에서 내부 리다이렉트를 발생.
- **try_files**: 요청을 다른 파일/디렉토리/URI로 전환.
- **rewrite**: URI를 변경하여 새로운 로케이션 검색.
- **error_page**: 특정 오류 코드 발생 시 재지정을 수행.

---

### 결론 (Conclusion)

Nginx의 요청 처리 메커니즘을 이해하면 관리자로서 서버를 더욱 효과적으로 운영할 수 있습니다. 서버 블록과 로케이션 블록이 선택되는 과정을 이해하면 요청 처리 흐름을 예측할 수 있습니다. 이를 통해 더욱 신뢰할 수 있는 서버 구성을 만들 수 있을 것입니다.
